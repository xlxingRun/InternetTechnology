# 在线视频流媒体传输技术调研报告 Version 0.8

**作者：邢小林**

未完成...

1、KCP：基于传输层UDP协议，使用Golang设计并实现，完全由算法来实现，在协议栈中UDP之上，可以说是传输层与应用层之间的中间件层。

[xtaci/kcp-go: A Crypto-Secure, Production-Grade Reliable-UDP Library for golang with FEC (github.com)](https://github.com/xtaci/kcp-go)

[kcp package - github.com/xtaci/kcp-go - pkg.go.dev](https://pkg.go.dev/github.com/xtaci/kcp-go#section-readme)

[skywind3000/kcp: KCP - A Fast and Reliable ARQ Protocol (github.com)](https://github.com/skywind3000/kcp)

[kcptun开发小记 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/53849089)

2、流媒体传输协议：

基于UDP：

- RTP(Real-time Transport Protocol)、RTCP(Real-time Transport Control Protocol)

现在Google推出的WebRTC

基于TCP：

- RTMP(Real Time Messaging Protocol)
- HLS(HTTP Live Streaming)


<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">
# 前言

付费平台B2C：爱奇艺、腾讯视频、优酷视频

公开平台C2C：哔哩哔哩、YouTube

<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">
# 一、中国在线视频平台可以分为三大梯队

数据来源：《2020年中国网络视频行业分析报告-市场规模现状与投资前景预测》

据数据统计显示：截至2019年6月，我国网络视频用户（含短视频）规模达7.59亿，较2018年底增长3391万，占网民整体的88.8%。其中长视频用户规模为6.39亿，占网民整体的74.7%；短视频用户规模为6.48亿，占网民整体的75.8%。

2019年上半年，各大视频平台进一步细分内容产品类型，并对其进行专业化生产和运营，行业的娱乐内容生态逐渐形成。在用户细分时代，各大视频平台不断开拓新兴品类市场，更加注重内容的针对性和专业性。在网络视频内容领域，为迎合多样化的用户喜好，各大视频平台以电视剧、电影、综艺、动漫等核心品类为基础，不断向游戏、电竞、音乐等新兴品类拓展。此外，各大视频平台利用大数据、人工智能等技术，快速识别用户需求，实现内容的精准推送；同时，各大平台深入分析用户内容消费、商品消费的相关数据，还原用户真实需求，助力生产优质内容。例如，优酷的鱼脑系统已经被全面应用到网络剧、综艺节目的策划生产中。

第一梯队以爱奇艺、腾讯视频、优酷为首，分别背靠百度、腾讯、阿里巴巴三大互联网巨头，平台内容成本投入较大，综合片源丰富，活跃用户居于前列。

第二梯队包括以芒果TV、哔哩哔哩为代表的特色视频平台，其中前者背靠湖南卫视，拥有独家优质综艺内容，后者则通过“二次元”文化吸引了固定的用户群。

第三梯队以PP视频、搜狐视频、咪咕视频等为代表，主要走差异化路线，如PP视频主打体育内容，由于整体资金投入相对较少，难以前两个梯队的平台抗衡。

# 二、在线视频流传输协议概述

## 前言

https://baijiahao.baidu.com/s?id=1661866108920487828&wfr=spider&for=pc

流数据具有数据量大、实时传输等特点，它对网络传输具有高带宽、低时延、同步和高可靠性的要求，为了保证好的QoS，传输模式、协议栈和应用体系控制等问题就显得非常重要。

## ▶RTP数据流协议

https://www.rfc-editor.org/info/rfc3550

RTP英文全称Real-time Transport Protocol实时流传输协议。在RFC中定义为RFC3550/RFC3551。RTP由IETF（Internet Engineering Task Force，互联网工程任务组）工作组制定。

该协议主要实现实时数据的传输，它在数据包头中提供编码类型，包中数据的采样时刻、数据包的序号，依据这些信息传输双方可以协商编码类型，可以对数据包进行排序。

RTP协议是建立在UDP协议上的。RTP协议详细说明了在互联网上传递音频和视频的标准数据包格式。RTP协议常用于流媒体系统（配合RTCP协议）、视频会议和视频电话系统（配合H.263或SIP）。

RTP 本身并没有服务质量保证机制，它依赖于低层服务去实现这一过程。

在协议栈角度上，从实现功能角度上看，RTP可以划分到传输层，从应用开发者的角度看，可以归为应用层，操作系统中的TCP/IP等协议栈所提供的是我们最常用的服务，而RTP的实现还是要靠开发者自己。因此从开发的角度来说，RTP的实现和应用层协议的实现没有不同，所以可将RTP看成应用层协议。

## ▶RTCP数据流协议

RTCP英文全称Real-time Transport Control Protocol，实时传输控制协议，该协议是RTP数据流协议的一个姐妹协议。RTCP为RTP数据流提供信道外控制。RTCP并不传输数据，它和RTP协作将多媒体数据打包和发送。RTCP的主要功能是保证服务质量，为RTP提供服务质量反馈。

## SRTP && SRTCP数据流协议

https://datatracker.ietf.org/doc/rfc3711/

SRTP英文全称为Secure Real-time Transport Protocol安全实时传输协议，该协议是在实时传输协议RTP基础上定义的一个协议，旨在为RTP数据提供**加密、消息认证、完整性保证和重放保护**。可以参考文档RFC3711。

RTCP同样也有一个伴生协议，它被称为安全实时传输控制协议Secure RTCP或SRTCP。在使用实时传输协议或实时传输控制协议时，是应用安全传输协议还是明文传输在数据传输过程中是可以选择的。

## RTSP数据流协议

https://datatracker.ietf.org/doc/rfc2326/

RTSP英文全称Real Time Streaming Protocol实时串流协议，该协议由Real Networks和Netscape共同提出的，它是用来控制流数据串的协议。该协议定义了一对多应用程序如何有效地通过IP网络传送流数据。RTSP提供了一个可扩展框架，使实时数据，如音视频的受控、点播成为可能。

它允许同时对多个串流控制，服务器端可以自行选择使用TCP或UDP来传送串流内容，它的语法和运作跟HTTP 1.1类似，能容忍网络延迟。详情可以参考文档RFC2326。

<img src="RTP RTSP RSVP协议层图.jpeg" alt="RTP RTSP RSVP协议层图" style="zoom:50%;" />

RTSP与RTP最大的区别在于，RTSP是RTP的上层协议，是一种类似与http协议的网络应用层协议。RTSP允许双向实时数据传输，它允许客户端向服务器端发送控制操作，例如回放、快进、倒退等操作。此外，RTSP既可以使用RTP来传送数据，还可以选择TCP、UDP等通道来传输数据。

## RSVP协议

RSVP英文全称Resource reSerVation Protocol资源预留协议，该协议是**网络层协议**，它是针对IP网络传输层不能保证QoS和支持多点传输而提出的协议。RSVP事先在业务流传输前预约网络资源，建立静态或动态的传输逻辑通路，保证每一业务流都有足够的带宽，这样能够提高传输质量。

RSVP是由接收方执行操作的协议，接收方决定预留资源的优先级，并对预留资源进行初始化和管理。RSVP共有三种预留资源类型，无滤包器、固定滤包器和动态滤包器。

![RTP、RTCP、RTVP、RTSP功能图示](RTP、RTCP、RTVP、RTSP功能图示.jpeg)

上述内容作为一个了解，没有形成成熟的工业化解决方案，RTMP和HLS是流媒体传输使用的主流协议。

------

## RTMP和RTMPS协议（HTTP-FLV）

RTMP英文全称Real Time Messaging Protocol实时消息传送协议。它是Adobe Systems公司为Flash播放器和服务器之间流数据传输开发的开放协议。flv是RTMP使用的封装格式。

rtmp 数据需要专门的服务器接收， 如FMS, awazal等，然后通过本地的 Flash 播放器播放。

RTMP协议有三个分支：

- 第一种是工作在TCP协议上的明文传输，它使用的端口是1935；
- 第二种是RTMPT，RTMPT被封装在HTTP请求之中，可以穿越防火墙进行传输；RTMPT和HTTP-FLV应该是同一个东西。
- 第三种是RTMPS，它也是封装在HTTP之中，不过与RTMPT不同的是，它使用HTTPS安全连接，可以保证传输的安全。

## HLS数据流传输协议

https://www.jianshu.com/p/32417d8ee5b6

HLS英文全称HTTP Live Streaming在线流传输协议，该协议是由美国苹果公司实现的基于HTTP的流数据传输协议，可以实现流媒体的直播和点播。该协议主要为iOS系统服务。

HLS实际上并不是真正的实时流协议，HLS协议在服务器端将数据流存储为连续的、短时长的MPEG-TS格式文件，客户端不断下载并解析播放这些小文件从而实现实时流效果。可以认为，HLS是以点播流技术方式来实现实时流的协议。这样的缺点是延时高。

RTMP是APP中最常用的数据流传输协议，它可以做到低延时。RTMP协议进行数据传输时，它将一整条数据流封装成FLV通过HTTP打包、TCP长连接分发出去，在服务器端不产生落地文件，延时通常为 1至3秒，远超HLS。

HLS协议通过切片传输数据，边下载边传输，所以传输延时要比RTMP长。但是，HLS基于HTTP/80 传输，很少会被防火墙拦下。HLS基于无状态协议（HTTP）支持平滑扩展，RTMP对视频服务器进行平滑扩展困难。

做APP数据流时一般会选择RTMP而不是HLS，特殊情况是微信端不支持RTMP，所以HLS表现良好。

[腾讯云直播架构](https://www.livevideostack.cn/news/腾讯云低延时直播系统架构设计与弱网优化实践/)

![3种协议比较](3种协议比较.png)

# 三、知名产品在线视频流传输协议调查

## 1、爱奇艺



## 2、腾讯视频

TCP

## 3、优酷视频

TCP

HTTPS

## 4、哔哩哔哩

HTTP-FLV && TCP

[HTML5 FLV Player](https://github.com/bilibili/flv.js)

An HTML5 Flash Video (FLV) Player written in pure JavaScript without Flash. LONG LIVE FLV!

使用的视频流传输技术是http-flv，开源了flv.js，可以使用html5播放器播放flv视频，而不依赖flash插件。

<hr style=" border:solid; width:100px; height:1px;" color=#000000 size=1">


# 总结

目前国内的互联网厂商的在线视频流媒体传输技术主要以https为主，有很多显而易见的优点，包括易于实现，扩展性好，免于被防火墙过滤，可以适配CDN。RTMP是专门设计的流媒体传输协议，具有很好的传输效率和用户体验，并且事实上很长一段时间内成为了行业标准，是一套成熟的解决方案，但是该协议为adobe的私有协议，想要使用需要支付专利费用，维护方面配置专门的服务器，客户端安装flash插件（当下flash已经被浏览器抛弃）等。

在线视频的流媒体传输属于点播，对实时性要求不高，使用TCP技术门槛低，并且足够提供良好的服务。综合多种流媒体传输协议的优缺点，国内主流厂商普遍选择RTMP+HTTP混合的传输技术，即http-flv。在TCP/IP协议栈中，传输层协议是TCP，上层协议是http和rtmp。
